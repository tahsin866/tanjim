<template>
  <Head title="‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ" />
  
  <AuthenticatedLayout>
    <div class="max-w-6xl mx-auto mt-8 p-6 bg-white rounded shadow border">
      <h2 class="text-2xl font-bold mb-6 text-center">‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ</h2>

      <!-- Tab Navigation -->
      <div class="border-b border-gray-200 mb-6">
        <nav class="-mb-px flex space-x-8">
          <button
            v-for="tab in tabs"
            :key="tab.id"
            @click="activeTab = tab.id"
            :class="[
              'py-2 px-1 border-b-2 font-medium text-sm',
              activeTab === tab.id
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
            ]"
          >
            {{ tab.name }}
          </button>
        </nav>
      </div>

      <!-- Tab 1: ‡¶Æ‡ßÇ‡¶≤ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø -->
      <div v-show="activeTab === 'main-event'" class="space-y-6">
        <h3 class="text-xl font-semibold mb-4">‡¶Æ‡ßÇ‡¶≤ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Event Form -->
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ *</label>
              <input
                v-model="newMainEvent.name"
                type="text"
                class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡ß≠‡ß¶ ‡¶∏‡¶æ‡¶≤‡¶æ‡¶®‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶∑‡ßç‡¶†‡¶æ‡¶®"
              />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</label>
              <textarea
                v-model="newMainEvent.description"
                rows="4"
                class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."
              ></textarea>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
              <input
                v-model="newMainEvent.date"
                type="date"
                class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡¶∏‡ßç‡¶•‡¶æ‡¶®</label>
              <input
                v-model="newMainEvent.location"
                type="text"
                class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶∏‡ßç‡¶•‡¶æ‡¶®"
              />
            </div>
            
            <button
              @click="addMainEvent"
              :disabled="!newMainEvent.name"
              class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-md font-medium"
            >
              ‡¶Æ‡ßÇ‡¶≤ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
          </div>
          
          <!-- Existing Events List -->
          <div>
            <h4 class="text-lg font-medium mb-3">‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶Æ‡ßÇ‡¶≤ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</h4>
            <div class="space-y-2 max-h-96 overflow-y-auto">
              <div
                v-for="event in mainEvents"
                :key="event.id"
                class="p-3 border rounded-md bg-gray-50"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <h5 class="font-medium">{{ event.name }}</h5>
                    <p class="text-sm text-gray-600">{{ event.description }}</p>
                    <p class="text-xs text-gray-500 mt-1">
                      üìÖ {{ event.date }} | üìç {{ event.location }}
                    </p>
                  </div>
                  <button
                    @click="deleteMainEvent(event.id)"
                    class="text-red-500 hover:text-red-700 text-sm"
                  >
                    ‚ùå
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab 2: ‡¶∏‡¶æ‡¶¨-‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø -->
      <div v-show="activeTab === 'sub-event'" class="space-y-6">
        <h3 class="text-xl font-semibold mb-4">‡¶∏‡¶æ‡¶¨-‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Sub Event Form -->
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡¶Æ‡ßÇ‡¶≤ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® *</label>
              <select
                v-model="newSubEvent.parent_id"
                class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              >
                <option value="">-- ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
                <option v-for="event in mainEvents" :key="event.id" :value="event.id">
                  {{ event.name }}
                </option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡¶∏‡¶æ‡¶¨-‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ *</label>
              <input
                v-model="newSubEvent.name"
                type="text"
                class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶§‡¶æ‡¶ï‡¶Æ‡¶ø‡¶≤, ‡¶π‡¶ø‡¶´‡¶ú, ‡¶ï‡¶ø‡¶∞‡¶æ‡¶§"
              />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡¶´‡¶ø (‡¶ü‡¶æ‡¶ï‡¶æ‡¶Ø‡¶º) *</label>
              <input
                v-model.number="newSubEvent.fee"
                type="number"
                min="0"
                class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="‡ß¶"
              />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</label>
              <textarea
                v-model="newSubEvent.description"
                rows="3"
                class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="‡¶∏‡¶æ‡¶¨-‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£..."
              ></textarea>
            </div>
            
            <button
              @click="addSubEvent"
              :disabled="!newSubEvent.name || !newSubEvent.parent_id || newSubEvent.fee < 0"
              class="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-md font-medium"
            >
              ‡¶∏‡¶æ‡¶¨-‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
          </div>
          
          <!-- Existing Sub Events List -->
          <div>
            <h4 class="text-lg font-medium mb-3">‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶∏‡¶æ‡¶¨-‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π</h4>
            <div class="space-y-2 max-h-96 overflow-y-auto">
              <div
                v-for="subEvent in subEvents"
                :key="subEvent.id"
                class="p-3 border rounded-md bg-blue-50"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <h5 class="font-medium">{{ subEvent.name }}</h5>
                    <p class="text-sm text-blue-600">{{ getMainEventName(subEvent.parent_id) }}</p>
                    <p class="text-sm text-gray-600">{{ subEvent.description }}</p>
                    <p class="text-sm font-medium text-green-600 mt-1">‡¶´‡¶ø: {{ subEvent.fee }}‡ß≥</p>
                  </div>
                  <button
                    @click="deleteSubEvent(subEvent.id)"
                    class="text-red-500 hover:text-red-700 text-sm"
                  >
                    ‚ùå
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab 3: ‡¶õ‡¶æ‡¶°‡¶º/‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ -->
      <div v-show="activeTab === 'discount'" class="space-y-6">
        <h3 class="text-xl font-semibold mb-4">‡¶õ‡¶æ‡¶°‡¶º/‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ</h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Discount Form -->
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡¶õ‡¶æ‡¶°‡¶º‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ *</label>
              <input
                v-model="newDiscount.name"
                type="text"
                class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶ï‡¶Æ‡ßç‡¶¨‡ßã ‡¶õ‡¶æ‡¶°‡¶º, ‡¶Ü‡¶∞‡ßç‡¶≤‡¶ø ‡¶¨‡¶æ‡¶∞‡ßç‡¶° ‡¶õ‡¶æ‡¶°‡¶º"
              />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡¶õ‡¶æ‡¶°‡¶º‡ßá‡¶∞ ‡¶π‡¶æ‡¶∞ (%) *</label>
              <input
                v-model.number="newDiscount.percentage"
                type="number"
                min="0"
                max="100"
                class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="‡ßß‡ß¶"
              />
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶∏‡¶æ‡¶¨-‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π *</label>
              <div class="space-y-2 max-h-40 overflow-y-auto border rounded-md p-3">
                <div
                  v-for="subEvent in subEvents"
                  :key="subEvent.id"
                  class="flex items-center"
                >
                  <input
                    type="checkbox"
                    :id="'discount-sub-' + subEvent.id"
                    :value="subEvent.id"
                    v-model="newDiscount.applicable_events"
                    class="mr-2"
                  />
                  <label :for="'discount-sub-' + subEvent.id" class="text-sm">
                    {{ subEvent.name }} ({{ getMainEventName(subEvent.parent_id) }}) - {{ subEvent.fee }}‡ß≥
                  </label>
                </div>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ</label>
              <textarea
                v-model="newDiscount.conditions"
                rows="3"
                class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="‡¶õ‡¶æ‡¶°‡¶º ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ..."
              ></textarea>
            </div>
            
            <button
              @click="addDiscount"
              :disabled="!newDiscount.name || !newDiscount.percentage || newDiscount.applicable_events.length === 0"
              class="w-full bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 text-white px-4 py-2 rounded-md font-medium"
            >
              ‡¶õ‡¶æ‡¶°‡¶º ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
          </div>
          
          <!-- Existing Discounts List -->
          <div>
            <h4 class="text-lg font-medium mb-3">‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶õ‡¶æ‡¶°‡¶º‡¶∏‡¶Æ‡ßÇ‡¶π</h4>
            <div class="space-y-2 max-h-96 overflow-y-auto">
              <div
                v-for="discount in discounts"
                :key="discount.id"
                class="p-3 border rounded-md bg-purple-50"
              >
                <div class="flex justify-between items-start">
                  <div>
                    <h5 class="font-medium">{{ discount.name }}</h5>
                    <p class="text-sm text-purple-600 font-medium">{{ discount.percentage }}% ‡¶õ‡¶æ‡¶°‡¶º</p>
                    <p class="text-sm text-gray-600 mt-1">{{ discount.conditions }}</p>
                    <div class="mt-2">
                      <p class="text-xs text-gray-500 mb-1">‡¶™‡ßç‡¶∞‡¶Ø‡ßã‡¶ú‡ßç‡¶Ø ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡¶∏‡¶Æ‡ßÇ‡¶π:</p>
                      <div class="flex flex-wrap gap-1">
                        <span
                          v-for="eventId in discount.applicable_events"
                          :key="eventId"
                          class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded"
                        >
                          {{ getSubEventName(eventId) }}
                        </span>
                      </div>
                    </div>
                  </div>
                  <button
                    @click="deleteDiscount(discount.id)"
                    class="text-red-500 hover:text-red-700 text-sm"
                  >
                    ‚ùå
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab 4: ‡¶´‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞ -->
      <div v-show="activeTab === 'calculator'" class="space-y-6">
        <h3 class="text-xl font-semibold mb-4">‡¶´‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞</h3>
        
        <div class="max-w-2xl mx-auto">
          <!-- Parent Event Selection -->
          <div class="mb-4">
            <label class="block mb-2 font-semibold">‡¶Æ‡ßÇ‡¶≤ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
            <select v-model="calculator.selectedParent" class="w-full border rounded-md px-3 py-2">
              <option value="">-- ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® --</option>
              <option v-for="event in mainEvents" :value="event.id" :key="event.id">
                {{ event.name }}
              </option>
            </select>
          </div>

          <!-- Sub Event Checkboxes -->
          <div v-if="calculatorSubEvents.length" class="mb-4">
            <label class="block mb-2 font-semibold">‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®:</label>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
              <div v-for="subEvent in calculatorSubEvents" :key="subEvent.id" class="flex items-center p-2 border rounded">
                <input
                  type="checkbox"
                  :id="'calc-sub-'+subEvent.id"
                  :value="subEvent.id"
                  v-model="calculator.selectedSubs"
                  class="mr-2"
                />
                <label :for="'calc-sub-'+subEvent.id" class="flex-1">
                  {{ subEvent.name }}
                  <span class="text-sm text-green-600 font-medium">({{ subEvent.fee }}‡ß≥)</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Discount Selection -->
          <div v-if="calculator.selectedSubs.length" class="mb-4">
            <label class="block mb-2 font-semibold">‡¶õ‡¶æ‡¶°‡¶º/‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü:</label>
            <select v-model="calculator.selectedDiscount" class="w-full border rounded-md px-3 py-2">
              <option value="">-- ‡¶ï‡ßã‡¶®‡ßã ‡¶õ‡¶æ‡¶°‡¶º ‡¶®‡ßá‡¶á --</option>
              <option v-for="discount in applicableDiscounts" :value="discount.id" :key="discount.id">
                {{ discount.name }} ({{ discount.percentage }}% ‡¶õ‡¶æ‡¶°‡¶º)
              </option>
            </select>
          </div>

          <!-- Fee Summary -->
          <div v-if="calculator.selectedSubs.length" class="bg-gray-50 border rounded-md p-4 mb-4">
            <h4 class="font-semibold mb-3">‡¶´‡¶ø ‡¶∏‡¶æ‡¶∞‡¶∏‡¶Ç‡¶ï‡ßç‡¶∑‡ßá‡¶™</h4>
            
            <div class="space-y-2">
              <div v-for="subId in calculator.selectedSubs" :key="subId" class="flex justify-between">
                <span>{{ getSubEventName(subId) }}</span>
                <span>{{ getSubEventFee(subId) }}‡ß≥</span>
              </div>
            </div>
            
            <hr class="my-3">
            
            <div class="flex justify-between py-1">
              <span>‡¶Æ‡ßã‡¶ü ‡¶´‡¶ø:</span>
              <span class="font-medium">{{ calculatorTotalFee }}‡ß≥</span>
            </div>
            
            <div v-if="calculatorDiscountPercent > 0" class="flex justify-between py-1">
              <span>‡¶õ‡¶æ‡¶°‡¶º ({{ calculatorDiscountPercent }}%):</span>
              <span class="text-green-700 font-medium">-{{ calculatorDiscountAmount }}‡ß≥</span>
            </div>
            
            <hr class="my-2">
            
            <div class="flex justify-between font-bold text-lg">
              <span>‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶Æ‡ßã‡¶ü ‡¶´‡¶ø:</span>
              <span class="text-blue-600">{{ calculatorFinalFee }}‡ß≥</span>
            </div>
          </div>

          <!-- Submit Button -->
          <button
            v-if="calculator.selectedSubs.length"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-bold"
            @click="submitCalculation"
          >
            ‡¶´‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®
          </button>
        </div>
      </div>
    </div>
  </AuthenticatedLayout>
</template>

<script setup>
import { ref, computed, watch } from 'vue';
import { Head } from '@inertiajs/vue3';
import AuthenticatedLayout from '@/Layouts/admin/AuthenticatedLayout.vue';

// Tab Management
const activeTab = ref('main-event');
const tabs = [
  { id: 'main-event', name: '‡ßß. ‡¶Æ‡ßÇ‡¶≤ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü' },
  { id: 'sub-event', name: '‡ß®. ‡¶∏‡¶æ‡¶¨-‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü' },
  { id: 'discount', name: '‡ß©. ‡¶õ‡¶æ‡¶°‡¶º ‡¶¨‡ßç‡¶Ø‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶™‡¶®‡¶æ' },
  { id: 'calculator', name: '‡ß™. ‡¶´‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶ü‡¶∞' }
];

// Data Storage
const mainEvents = ref([
  { id: 1, name: '‡ß≠‡ß¶ ‡¶∏‡¶æ‡¶≤‡¶æ‡¶®‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶∑‡ßç‡¶†‡¶æ‡¶®', description: '‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ', date: '2024-12-31', location: '‡¶Æ‡¶æ‡¶¶‡¶∞‡¶æ‡¶∏‡¶æ ‡¶™‡ßç‡¶∞‡¶æ‡¶ô‡ßç‡¶ó‡¶£' }
]);

const subEvents = ref([
  { id: 1, parent_id: 1, name: '‡¶§‡¶æ‡¶ï‡¶Æ‡¶ø‡¶≤', fee: 1000, description: '‡¶§‡¶æ‡¶ï‡¶Æ‡¶ø‡¶≤ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ' },
  { id: 2, parent_id: 1, name: '‡¶π‡¶ø‡¶´‡¶ú', fee: 800, description: '‡¶π‡¶ø‡¶´‡¶ú ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ' },
  { id: 3, parent_id: 1, name: '‡¶ï‡¶ø‡¶∞‡¶æ‡¶§', fee: 900, description: '‡¶ï‡¶ø‡¶∞‡¶æ‡¶§ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ' },
  { id: 4, parent_id: 1, name: '‡¶Ü‡¶¶‡¶¨', fee: 850, description: '‡¶Ü‡¶¶‡¶¨ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ' },
  { id: 5, parent_id: 1, name: '‡¶á‡¶´‡¶§‡¶æ', fee: 950, description: '‡¶á‡¶´‡¶§‡¶æ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶Ø‡ßã‡¶ó‡¶ø‡¶§‡¶æ' },
  { id: 6, parent_id: 1, name: '‡¶π‡¶ø‡¶§‡¶æ‡¶ï‡¶æ‡¶ô‡ßç‡¶ñ‡¶ø', fee: 700, description: '‡¶π‡¶ø‡¶§‡¶æ‡¶ï‡¶æ‡¶ô‡ßç‡¶ñ‡¶ø ‡¶¨‡¶ø‡¶≠‡¶æ‡¶ó' }
]);

const discounts = ref([
  { 
    id: 1, 
    name: '‡¶ï‡¶Æ‡ßç‡¶¨‡ßã ‡¶õ‡¶æ‡¶°‡¶º (‡¶∏‡¶¨ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø)', 
    percentage: 10, 
    applicable_events: [1, 2, 3, 4, 5, 6],
    conditions: '‡¶∏‡¶ï‡¶≤ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶Ö‡¶Ç‡¶∂‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡¶≤‡ßá ‡ßß‡ß¶% ‡¶õ‡¶æ‡¶°‡¶º'
  }
]);

// Form Data
const newMainEvent = ref({
  name: '',
  description: '',
  date: '',
  location: ''
});

const newSubEvent = ref({
  parent_id: '',
  name: '',
  fee: 0,
  description: ''
});

const newDiscount = ref({
  name: '',
  percentage: 0,
  applicable_events: [],
  conditions: ''
});

// Calculator Data
const calculator = ref({
  selectedParent: '',
  selectedSubs: [],
  selectedDiscount: ''
});

// Helper Functions
let nextMainEventId = 2;
let nextSubEventId = 7;
let nextDiscountId = 2;

const getMainEventName = (id) => {
  const event = mainEvents.value.find(e => e.id === id);
  return event ? event.name : '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü';
};

const getSubEventName = (id) => {
  const event = subEvents.value.find(e => e.id === id);
  return event ? event.name : '‡¶Ö‡¶ú‡¶æ‡¶®‡¶æ ‡¶∏‡¶æ‡¶¨-‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü';
};

const getSubEventFee = (id) => {
  const event = subEvents.value.find(e => e.id === id);
  return event ? event.fee : 0;
};

// Main Event Functions
const addMainEvent = () => {
  if (!newMainEvent.value.name) return;
  
  mainEvents.value.push({
    id: nextMainEventId++,
    ...newMainEvent.value
  });
  
  // Reset form
  newMainEvent.value = {
    name: '',
    description: '',
    date: '',
    location: ''
  };
};

const deleteMainEvent = (id) => {
  if (confirm('‡¶è‡¶á ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
    mainEvents.value = mainEvents.value.filter(e => e.id !== id);
    // Also remove related sub events
    subEvents.value = subEvents.value.filter(e => e.parent_id !== id);
  }
};

// Sub Event Functions
const addSubEvent = () => {
  if (!newSubEvent.value.name || !newSubEvent.value.parent_id) return;
  
  subEvents.value.push({
    id: nextSubEventId++,
    ...newSubEvent.value
  });
  
  // Reset form
  newSubEvent.value = {
    parent_id: '',
    name: '',
    fee: 0,
    description: ''
  };
};

const deleteSubEvent = (id) => {
  if (confirm('‡¶è‡¶á ‡¶∏‡¶æ‡¶¨-‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
    subEvents.value = subEvents.value.filter(e => e.id !== id);
    // Remove from discounts
    discounts.value.forEach(d => {
      d.applicable_events = d.applicable_events.filter(eventId => eventId !== id);
    });
  }
};

// Discount Functions
const addDiscount = () => {
  if (!newDiscount.value.name || !newDiscount.value.percentage || newDiscount.value.applicable_events.length === 0) return;
  
  discounts.value.push({
    id: nextDiscountId++,
    ...newDiscount.value
  });
  
  // Reset form
  newDiscount.value = {
    name: '',
    percentage: 0,
    applicable_events: [],
    conditions: ''
  };
};

const deleteDiscount = (id) => {
  if (confirm('‡¶è‡¶á ‡¶õ‡¶æ‡¶°‡¶º ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?')) {
    discounts.value = discounts.value.filter(d => d.id !== id);
  }
};

// Calculator Computed Properties
const calculatorSubEvents = computed(() => {
  return subEvents.value.filter(e => e.parent_id == calculator.value.selectedParent);
});

const calculatorTotalFee = computed(() => {
  return calculator.value.selectedSubs.reduce((sum, subId) => {
    return sum + getSubEventFee(subId);
  }, 0);
});

const applicableDiscounts = computed(() => {
  return discounts.value.filter(discount => {
    return discount.applicable_events.every(eventId => 
      calculator.value.selectedSubs.includes(eventId)
    );
  });
});

const calculatorDiscountPercent = computed(() => {
  const discount = discounts.value.find(d => d.id == calculator.value.selectedDiscount);
  return discount ? discount.percentage : 0;
});

const calculatorDiscountAmount = computed(() => {
  return Math.round((calculatorTotalFee.value * calculatorDiscountPercent.value) / 100);
});

const calculatorFinalFee = computed(() => {
  return calculatorTotalFee.value - calculatorDiscountAmount.value;
});

// Calculator Watchers
watch(() => calculator.value.selectedParent, () => {
  calculator.value.selectedSubs = [];
  calculator.value.selectedDiscount = '';
});

watch(() => calculator.value.selectedSubs, () => {
  if (calculator.value.selectedDiscount && 
      !applicableDiscounts.value.some(d => d.id == calculator.value.selectedDiscount)) {
    calculator.value.selectedDiscount = '';
  }
});

// Submit Function
const submitCalculation = () => {
  const selectedSubNames = calculator.value.selectedSubs.map(id => getSubEventName(id)).join(', ');
  const discountName = discounts.value.find(d => d.id == calculator.value.selectedDiscount)?.name || '‡¶ï‡ßã‡¶®‡ßã ‡¶õ‡¶æ‡¶°‡¶º ‡¶®‡ßá‡¶á';
  
  alert(`
‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü: ${getMainEventName(calculator.value.selectedParent)}
‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶ø‡¶§ ‡¶∏‡¶æ‡¶¨-‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü: ${selectedSubNames}
‡¶Æ‡ßã‡¶ü ‡¶´‡¶ø: ${calculatorTotalFee.value}‡ß≥
‡¶õ‡¶æ‡¶°‡¶º: ${discountName} (-${calculatorDiscountAmount.value}‡ß≥)
‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶Æ‡ßã‡¶ü: ${calculatorFinalFee.value}‡ß≥
  `);
  
  // ‡¶è‡¶ñ‡¶æ‡¶®‡ßá API call ‡¶ï‡¶∞‡ßá ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®
};
</script>